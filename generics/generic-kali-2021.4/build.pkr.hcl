variable "generic_password" {
  type    = string
  default = "${env("TF_VAR_generic_password")}"
}

variable "generic_user" {
  type    = string
  default = "${env("TF_VAR_generic_user")}"
}

variable "vcenter_datastore" {
  type    = string
  default = "${env("TF_VAR_vcenter_datastore")}"
}

variable "vcenter_host" {
  type    = string
  default = "${env("TF_VAR_vcenter_host")}"
}

variable "vcenter_network0" {
  type    = string
  default = "${env("TF_VAR_network0")}"
}

variable "vcenter_network0_card" {
  type    = string
  default = "${env("TF_VAR_network0_card")}"
}

variable "vcenter_password" {
  type    = string
  default = "${env("TF_VAR_vcenter_password")}"
}

variable "vcenter_user" {
  type    = string
  default = "${env("TF_VAR_vcenter_user")}"
}

variable "build_version" {
  type    = string
  default = "${env("build_version")}"
}

source "vsphere-iso" "autogenerated_1" {
  CPUs                 = 1
  RAM                  = 4096
  RAM_reserve_all      = true
  boot_command         = ["<esc><wait>", "/install.amd/vmlinuz<wait>", " auto<wait>", " console-setup/ask_detect=false<wait>", " console-setup/layoutcode=fr<wait>", " console-setup/modelcode=pc105<wait>", " debconf/frontend=noninteractive<wait>", " debian-installer=fr_FR<wait>", " fb=false<wait>", " initrd=/install.amd/initrd.gz<wait>", " kbd-chooser/method=fr<wait>", " netcfg/choose_interface=eth0<wait>", " console-keymaps-at/keymap=fr<wait>", " keyboard-configuration/xkb-keymap=fr<wait>", " keyboard-configuration/layout=FR<wait>", " keyboard-configuration/variant=FR<wait>", " locale=fr_FR<wait>", " netcfg/get_domain=vm<wait>", " netcfg/get_hostname=kali<wait>", " grub-installer/bootdev=/dev/sda<wait>", " noapic<wait>", " preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg auto=true priority=critical", " -- <wait>", "<enter><wait>"]
  boot_wait            = "10s"
  datastore            = "${var.vcenter_datastore}"
  disk_controller_type = ["pvscsi"]
  guest_os_type        = "debian10_64Guest"
  host                 = "${var.vcenter_host}"
  http_directory       = "http"
  insecure_connection  = "true"
  iso_checksum         = "13c8ed5b87462e966c5afca129a4b76247f5b2b166733a13d154d1a1d31521d3"
  iso_urls             = ["https://cdimage.kali.org/kali-2021.4/kali-linux-2021.4-installer-amd64.iso"]
  network_adapters {
    network      = "${var.vcenter_network0}"
    network_card = "${var.vcenter_network0_card}"
  }
  password     = "${var.vcenter_password}"
  shutdown_command = "echo ${var.generic_password}|sudo -S shutdown -P now"
  ssh_password     = "${var.generic_password}"
  ssh_username     = "${var.generic_user}"
  ip_wait_timeout = "1h"
  ssh_wait_timeout = "1h"
  storage {
    disk_size             = 30000
    disk_thin_provisioned = true
  }
  username       = "${var.vcenter_user}"
  vcenter_server = "${var.vcenter_host}"
  video_ram      = 16000
  vm_name        = "${var.build_version}-generic-kali-2021.4"
}

build {

  sources = ["source.vsphere-iso.autogenerated_1"]

  provisioner "shell" {
    inline = ["echo 'Installation done!'"]
  }

}
